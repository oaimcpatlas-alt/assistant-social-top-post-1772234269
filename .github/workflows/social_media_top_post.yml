
name: social-media-top-post
on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/social_media_top_post.yml'
      - 'social_media_auth.py'
      - 'social_media_top_post.js'

permissions:
  contents: write

jobs:
  solve:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          pip install requests playwright
          python -m playwright install --with-deps chromium
          npm install mongodb ws

      - name: Authenticate and mint browser cookies
        run: |
          python social_media_auth.py || true
          test -f social_media_auth_debug.json && cat social_media_auth_debug.json | head -c 40000 || true
          test -f social_media_browser_debug.json && cat social_media_browser_debug.json | head -c 30000 || true

      - name: Query top social media post
        run: |
          node social_media_top_post.js || true
          test -f social_media_top_post_result.json && cat social_media_top_post_result.json | head -c 30000 || true

      - name: Commit outputs
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md .github/workflows/social_media_top_post.yml social_media_auth.py social_media_top_post.js package.json package-lock.json || true
          for f in social_media_auth_debug.json social_media_browser_debug.json social_media_browser_cookies.json social_media_top_post_result.json; do
            if [ -f "$f" ]; then git add "$f"; fi
          done
          git commit -m "Write social media top post outputs" || exit 0
          for i in 1 2 3 4 5 6 7 8; do
            git pull --rebase origin main || true
            git push origin HEAD:main && exit 0 || true
            sleep 15
          done
          exit 0
