
name: social-media-top-post
on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/social_media_top_post.yml'
      - 'social_media_direct_query.py'

permissions:
  contents: write

jobs:
  solve:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      MONGO_URI: "mongodb+srv://oaimcpatlas_db_user:pdVEIpUnn0quf2Mr@mcpatlas.zlknsyp.mongodb.net"
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install deps
        run: |
          pip install pymongo

      - name: Query social media collection directly
        run: |
          python social_media_direct_query.py
          cat social_media_top_post_result.json

      - name: Commit outputs
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md .github/workflows/social_media_top_post.yml social_media_direct_query.py social_media_top_post_result.json
          git commit -m "Write social media top post outputs" || exit 0
          for i in 1 2 3 4 5 6; do
            git pull --rebase origin main || true
            git push origin HEAD:main && exit 0 || true
            sleep 15
          done
          exit 0
